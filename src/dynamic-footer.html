<script>
    // Dynamic Footer JavaScript + Search Functionality for Quarto Blog
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ Script loaded!');
        
        // í˜„ì¬ í˜ì´ì§€ ê°ì§€
        function setActiveNavbarItem() {
            const currentPath = window.location.pathname;
            const isAboutPage = currentPath.includes('about') || 
                               window.location.href.includes('about') ||
                               document.title.includes('Junhyuck Kwon');
            
            if (isAboutPage) {
                document.body.setAttribute('data-page', 'about');
            } else {
                document.body.setAttribute('data-page', 'index');
            }
            
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (isAboutPage && link.getAttribute('href') && link.getAttribute('href').includes('about')) {
                    link.classList.add('active');
                }
            });
        }
        
        // ê²€ìƒ‰ ê¸°ëŠ¥ - ë©”ì¸ í˜ì´ì§€ì—ì„œë§Œ
        function initializeSearch() {
            console.log('ğŸ“ Current path:', window.location.pathname);
            
            // ë©”ì¸ í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ return
            const isMainPage = window.location.pathname === '/' || 
                              window.location.pathname === '/index.html';
            
            if (!isMainPage) {
                console.log('âŒ Not main page, skipping search');
                return;
            }
            
            console.log('âœ… Main page detected, adding search');
            
            // title block ì°¾ê¸°
            const titleBlock = document.querySelector('.quarto-title-banner');
            if (!titleBlock) {
                console.log('âŒ No title block found');
                return;
            }
            
            // ê¸°ì¡´ ê²€ìƒ‰ ì œê±°
            const existing = titleBlock.querySelector('.search-container');
            if (existing) existing.remove();
            
            // ê²€ìƒ‰ ì»¨í…Œì´ë„ˆ ìƒì„±
            const searchHTML = `
                <div class="search-container">
                    <input type="text" 
                           class="search-input" 
                           placeholder="í¬ìŠ¤íŠ¸ ê²€ìƒ‰..." 
                           id="blog-search">
                    <button class="search-button" type="button" id="search-btn">
                        <svg class="search-icon" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                    </button>
                    <div class="search-results" id="search-results"></div>
                </div>
            `;
            
            titleBlock.insertAdjacentHTML('beforeend', searchHTML);
            console.log('âœ… Search HTML added');
            
            // í¬ìŠ¤íŠ¸ ë°ì´í„° ìˆ˜ì§‘
            function getAllPosts() {
                const posts = [];
                
                // ëª¨ë“  ê°€ëŠ¥í•œ ë§í¬ ì°¾ê¸°
                const links = document.querySelectorAll('a[href*="posts/"]');
                console.log('ğŸ” Found links:', links.length);
                
                links.forEach(link => {
                    const href = link.href;
                    const title = link.textContent.trim();
                    
                    if (title && href && !posts.some(p => p.href === href)) {
                        // ì„¤ëª… ì°¾ê¸°
                        let description = '';
                        const parent = link.closest('.quarto-post, .listing-item, .g-col-1');
                        if (parent) {
                            const descEl = parent.querySelector('.listing-description, .description, p');
                            if (descEl) {
                                description = descEl.textContent.trim();
                            }
                        }
                        
                        posts.push({
                            title: title,
                            description: description,
                            href: href
                        });
                        console.log(`ğŸ“ Added: "${title}"`);
                    }
                });
                
                console.log('ğŸ“Š Total posts collected:', posts.length);
                return posts;
            }
            
            // ê²€ìƒ‰ ì‹¤í–‰
            function performSearch(query) {
                console.log('ğŸ” Searching for:', query);
                
                const resultsDiv = document.getElementById('search-results');
                if (!resultsDiv) return;
                
                if (!query.trim()) {
                    resultsDiv.classList.remove('active');
                    return;
                }
                
                const posts = getAllPosts();
                const filtered = posts.filter(post => 
                    post.title.toLowerCase().includes(query.toLowerCase()) ||
                    post.description.toLowerCase().includes(query.toLowerCase())
                );
                
                console.log('ğŸ“‹ Found matches:', filtered.length);
                
                if (filtered.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    resultsDiv.innerHTML = filtered.slice(0, 5).map(post => `
                        <div class="search-result-item" onclick="window.location.href='${post.href}'">
                            <div class="search-result-title">${post.title}</div>
                            ${post.description ? `<div class="search-result-excerpt">${post.description.substring(0, 100)}...</div>` : ''}
                        </div>
                    `).join('');
                }
                
                resultsDiv.classList.add('active');
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            setTimeout(() => {
                const searchInput = document.getElementById('blog-search');
                const searchBtn = document.getElementById('search-btn');
                const searchResults = document.getElementById('search-results');
                
                if (!searchInput || !searchBtn || !searchResults) {
                    console.log('âŒ Search elements not found after timeout');
                    return;
                }
                
                console.log('âœ… Attaching event listeners');
                
                // ì´ˆê¸° í¬ìŠ¤íŠ¸ ë°ì´í„° ìˆ˜ì§‘ ì‹œë„
                let posts = getAllPosts();
                if (posts.length === 0) {
                    console.log('â³ No posts found initially, will retry during search');
                }
                
                let timeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        performSearch(this.value);
                    }, 300);
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performSearch(this.value);
                    }
                });
                
                searchBtn.addEventListener('click', function() {
                    performSearch(searchInput.value);
                });
                
                // ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸°
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.search-container')) {
                        searchResults.classList.remove('active');
                    }
                });
                
                console.log('âœ… Search functionality ready!');
                
            }, 2000); // 2ì´ˆë¡œ ì§€ì—° ì¦ê°€
        }
        
        // CTA ê¸°ëŠ¥
        function addCTAFunctionality() {
            const isMainPage = window.location.pathname === '/' || 
                              window.location.pathname === '/index.html' ||
                              window.location.pathname.endsWith('/');
            
            if (!isMainPage) return;
            
            const postElements = document.querySelectorAll('.quarto-post .thumbnail, .quarto-post .card-img-top, .quarto-post .listing-item-img-placeholder');
            
            postElements.forEach(element => {
                if (!element.hasAttribute('data-cta-enabled')) {
                    element.setAttribute('data-cta-enabled', 'true');
                    
                    element.addEventListener('click', function(e) {
                        e.preventDefault();
                        const parentPost = this.closest('.quarto-post');
                        if (parentPost) {
                            const titleLink = parentPost.querySelector('.listing-title a');
                            if (titleLink) {
                                window.location.href = titleLink.href;
                            }
                        }
                    });
                }
            });
        }
        
        // ì‹¤í–‰
        setActiveNavbarItem();
        initializeSearch();
        addCTAFunctionality();
        
        // About í˜ì´ì§€ ê°ì§€
        const isAboutPage = window.location.pathname.includes('about') || 
                           window.location.href.includes('about') ||
                           document.title.includes('Junhyuck Kwon');
        
        // ë™ì  í‘¸í„° ìƒì„±
        const footer = document.createElement('div');
        footer.className = 'dynamic-footer';
        footer.innerHTML = `
            <div class="footer-content">
                <div class="footer-left" style="margin-left: 30px;">
                    <span>Â© 2025 ì—¬ì•” Daily Logs</span>
                </div>
            </div>
        `;
        document.body.appendChild(footer);
    
        const scrollIndicator = document.createElement('div');
        scrollIndicator.className = 'scroll-indicator';
        document.body.appendChild(scrollIndicator);
        
        // About í˜ì´ì§€ëŠ” ì •ì  í‘¸í„°
        if (isAboutPage) {
            footer.classList.add('show');
            footer.style.position = 'relative';
            footer.style.transform = 'none';
            footer.style.opacity = '1';
            footer.style.visibility = 'visible';
            return;
        }
    
        // ìŠ¤í¬ë¡¤ ì²˜ë¦¬ (ë‹¤ë¥¸ í˜ì´ì§€)
        let lastScrollTop = 0;
        let ticking = false;
    
        function handleScroll() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = Math.max(
                document.body.scrollHeight,
                document.body.offsetHeight,
                document.documentElement.clientHeight,
                document.documentElement.scrollHeight,
                document.documentElement.offsetHeight
            );
    
            const scrollPercent = (scrollTop / Math.max(documentHeight - windowHeight, 1)) * 100;
            scrollIndicator.style.width = Math.min(scrollPercent, 100) + '%';
    
            const isShortPage = documentHeight - windowHeight < 200;
            const isNearBottom = scrollTop + windowHeight >= documentHeight * 0.8;
            
            const scrollDirection = scrollTop > lastScrollTop ? 'down' : 'up';
            const scrollDelta = Math.abs(scrollTop - lastScrollTop);
            
            if (scrollDelta > 5) {
                if (scrollDirection === 'down' && !isNearBottom && !isShortPage) {
                    footer.classList.remove('show');
                    footer.classList.add('hide');
                } else if (scrollDirection === 'up' || isNearBottom || isShortPage) {
                    footer.classList.remove('hide');
                    footer.classList.add('show');
                }
            }
            
            if (isNearBottom || isShortPage) {
                footer.classList.remove('hide');
                footer.classList.add('show');
            }
            
            if (scrollTop <= 10) {
                footer.classList.remove('show');
                footer.classList.add('hide');
            }
    
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        }
    
        function requestTick() {
            if (!ticking) {
                requestAnimationFrame(() => {
                    handleScroll();
                    ticking = false;
                });
                ticking = true;
            }
        }
    
        window.addEventListener('scroll', requestTick, { passive: true });
        footer.classList.add('hide');
    
        // ë™ì  ì½˜í…ì¸  ê´€ì°°
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    addCTAFunctionality();
                }
            });
        });
        
        const listingContainer = document.querySelector('#listing-listing');
        if (listingContainer) {
            observer.observe(listingContainer, {
                childList: true,
                subtree: true
            });
        }
    });
</script>